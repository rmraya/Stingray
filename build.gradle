plugins {
    id 'java'
    id 'application'
}

defaultTasks 'dist'

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

// No repositories needed since we're using local JARs
repositories {
    // Empty - using local JAR files only
}

dependencies {
    implementation files('jars/bcp47j.jar')
    implementation files('jars/json.jar')
    implementation files('jars/jsoup.jar')
    implementation files('jars/openxliff.jar')
    implementation files('jars/xmljava.jar')
}

application {
    mainModule = 'stingray'
}

sourceSets {
    main {
        java {
            srcDirs = ['src']
        }
        resources {
            srcDirs = ['src']
            exclude '**/*.java'
        }
    }
}

compileJava {
    outputs.upToDateWhen { false }

    doFirst {
        // Ensure a clean output folder before each compilation
        delete 'out'
        mkdir 'out'
    }

    options.compilerArgs = ['--module-path', configurations.compileClasspath.asPath]
    destinationDirectory = file('out')

    doLast {
        // Copy non-Java resources alongside compiled classes
        copy {
            from 'src'
            into 'out'
            exclude '**/*.java'
        }
        println "\u2713 Java compilation and resource copying completed"
    }
}

tasks.register('createJar', Jar) {
    dependsOn compileJava
    outputs.upToDateWhen { false }
    description = 'Build stingray.jar file'
    group = 'build'
    archiveBaseName = 'stingray'
    destinationDirectory = file('jars')
    from 'out'

    doFirst {
        delete 'jars/stingray.jar'
    }

    include '**/*'
    exclude '**/*.java'

    manifest {
        attributes(
            'Automatic-Module-Name': 'stingray',
            'Module-Path': configurations.runtimeClasspath.asPath
        )
    }

    doLast {
        println "\u2713 JAR created: ${archiveFile.get()}"
    }
}

tasks.register('linkJava', Exec) {
    dependsOn createJar
    outputs.upToDateWhen { false }

    doFirst {
        delete 'dist'
    }

    def pathSeparator = File.pathSeparator
    def fileSeparator = File.separator
    def javaHome = System.getProperty('java.home')
    def jmodsPath = javaHome + fileSeparator + 'jmods'
    def modulePath = 'jars' + pathSeparator + jmodsPath

    commandLine 'jlink',
        '--module-path', modulePath,
        '--add-modules', 'stingray',
        '--output', 'dist',
        '--verbose'

    doLast {
        def jrtFile = file('dist/lib/jrt-fs.jar')
        if (jrtFile.exists()) {
            delete jrtFile
        }
        println "\u2713 Runtime image created successfully"
    }
}

tasks.register('copyWindows') {
    dependsOn linkJava
    outputs.upToDateWhen { false }
    onlyIf { System.getProperty('os.name').toLowerCase().contains('windows') }

    doLast {
        delete 'bin', 'conf', 'legal', 'lib'
        delete 'release'

        copy {
            from 'dist/bin'
            into 'bin'
        }
        copy {
            from 'dist/conf'
            into 'conf'
        }
        copy {
            from 'dist/legal'
            into 'legal'
        }
        copy {
            from 'dist/lib'
            into 'lib'
        }
        copy {
            from 'dist/release'
            into '.'
        }
        delete 'dist'
        delete 'build'
        delete 'out'
    }
}

tasks.register('copyUnix') {
    dependsOn linkJava
    outputs.upToDateWhen { false }
    onlyIf { !System.getProperty('os.name').toLowerCase().contains('windows') }

    doLast {
        delete 'bin', 'conf', 'legal', 'lib'
        delete 'release'

        copy {
            from 'dist/bin'
            into 'bin'
        }
        copy {
            from 'dist/conf'
            into 'conf'
        }
        copy {
            from 'dist/legal'
            into 'legal'
        }
        copy {
            from 'dist/lib'
            into 'lib'
        }
        copy {
            from 'dist/release'
            into '.'
        }
        delete 'dist'
        delete 'build'
        delete 'out'
    }
}

tasks.register('dist') {
    dependsOn copyWindows, copyUnix
    outputs.upToDateWhen { false }
    description = 'Prepare distribution'

    doFirst {
        println "\u2713 Starting distribution build..."
    }

    doLast {
        delete 'jars/stingray.jar'
        println "\u2713 Distribution ready"
    }
}

tasks.register('distclean', Delete) {
    delete 'dist', 'bin', 'conf', 'include', 'legal', 'lib', 'release'
}

clean {
    delete 'out', 'build'
}
